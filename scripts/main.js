function randomInRange(e,t){return Math.floor(Math.random()*(1+t-e))+e}function plusOrMinus(){return Math.random()>.5?1:-1}function checkLeftOrRight(e,t,n,s,i,o){return(n-e)*(o-t)-(s-t)*(i-e)}function Game(){this.state=STATE.IDLE,this.score=0,this.objects=[],this.duration=DURATION.game,this.level=1,this.soundFX=new SoundFX,this.prevState="idle"}function Character(e,t,n,s){var i=30,o=e.board.image("images/characters/"+t+".png",n,s,i,i);o.type=t,o.direction=Math.random()*plusOrMinus(),o.moveTurn=randomInRange(0,50);var a=plusOrMinus(),r=plusOrMinus();return o.move=function(e,t,n){var s=parseInt(o.attr("x")),p=parseInt(o.attr("y"));50==++o.moveTurn&&(o.moveTurn=0,a=plusOrMinus(),r=plusOrMinus()),delX=a*n*MOVEMENT_CHARACTER[o.type].speedX,delY=r*n*MOVEMENT_CHARACTER[o.type].speedY,s+=delX,p+=delY,(i>s||s>e-i)&&(s-=2*delX,a*=plusOrMinus(),r*=plusOrMinus()),(i>p||p>t-i)&&(p-=2*delY,a*=plusOrMinus(),r*=plusOrMinus()),o.attr("x",s),o.attr("y",p)},o}function SoundFX(){Object.keys(SOUNDFX).forEach(function(e){var t=SOUNDFX[e];createjs.Sound.registerSound(t,e)}),this.play=function(e){createjs.Sound.play(e)}}function startGame(){document.getElementById("control-pane").style.display="none",game.init()}var IDCANVAS="#game-board",BASE_SCORE=10,STATE={IDLE:0,SELECTING:1,WAITING:2,TIMEUP:3},DURATION={selecting:1e3,waiting:1e3,game:180},LEVEL_SETTING={1:{objects:{cat:2,dog:2}},2:{objects:{cat:2,dog:2}}},MAX_LEVEL=Object.keys(LEVEL_SETTING).splice(-1,1),MOVEMENT_CHARACTER={dog:{speedX:5,speedY:5},cat:{speedX:6,speedY:6}},SOUNDFX={addObject:"https://www.freesound.org/data/previews/21/21389_36084-lq.mp3",awesome:"https://www.freesound.org/data/previews/187/187925_3140412-lq.mp3","oh-no":"http://freesound.org/data/previews/131/131409_2337290-lq.mp3"};Game.prototype.init=function(){this.board=Snap(IDCANVAS),this.sepLine=this.board.line(0,0,0,600),this.sepLine.addClass("separate-line"),document.getElementById("time").innerHTML=this.duration,this.initEvents(),this.setupLevel(),this.initObjectMovement(),this.start()},Game.prototype.initEvents=function(){function e(){t.sepLine.animate({opacity:0},DURATION.selecting,function(){t.sepLine.removeClass("show"),t.sepLine.attr("opacity",1),t.setState("waiting"),setTimeout(function(){t.setState("idle")},DURATION.waiting)})}var t=this;this.board.drag(function(n,s,i,o){if(t.sepLine.dx=n,t.sepLine.dy=s,t.state==STATE.WAITING)return void console.log("Please wait a little bit.");t.sepLine.addClass("show"),t.setState("selecting"),e();for(var a=[0,600],r=0;r<a.length;r++){var p="x"+(r+1);a[r]=n/s*(a[r]-t.sepLine.originY)+t.sepLine.originX,t.sepLine.attr(p,a[r])}},function(e,n){t.state!=STATE.waiting&&t.state!=STATE.TIMEUP&&(t.sepLine.originX=e,t.sepLine.originY=n)},function(n,s){t.setState("waiting"),t.state==STATE.SELECTING&&e()}),window.addEventListener("mouseup",function(n){t.computeScore(),t.setState("waiting"),e()},!1)},Game.prototype.initObjectMovement=function(){var e=this;setInterval(function(){var t=.5;e.state==STATE.SELECTING&&(t=.02);for(var n=0;n<e.objects.length;n++)e.objects[n].move(e.board.node.offsetWidth,e.board.node.offsetHeight,t)},50)},Game.prototype.start=function(){var e=this;e.timer=setInterval(function(){var t=e.duration--;document.getElementById("time").innerHTML=t,0==t&&e.stop()},1e3)},Game.prototype.stop=function(){clearInterval(this.timer),this.setState("timeup"),this.board.undrag()},Game.prototype.setupLevel=function(){var e=this,t=this.level;this.level>MAX_LEVEL&&(t=MAX_LEVEL);var n=LEVEL_SETTING[t];console.log(n.objects),Object.keys(n.objects).forEach(function(t){for(var s=0;s<n.objects[t];s++){e.soundFX.play("addObject");var i=new Character(e,t,randomInRange(15,e.board.node.offsetWidth-15),randomInRange(15,e.board.node.offsetHeight-15));e.objects.push(i)}})},Game.prototype.setState=function(e){var t=e.toUpperCase();if(-1==Object.keys(STATE).indexOf(t))throw new Error("This state doesn't exist : "+t);this.board.removeClass(this.prevState),this.state=STATE[e.toUpperCase()],this.board.addClass(e),this.prevState=e},Game.prototype.computeScore=function(){for(var e=this.objects.length/2,t=this.sepLine.originX,n=this.sepLine.originY,s=t+this.sepLine.dx,i=n+this.sepLine.dy,o={left:[],right:[]},a=0;a<this.objects.length;++a){var r=this.objects[a],p=r.attr("x"),d=r.attr("y"),c="right",h=checkLeftOrRight(t,n,s,i,p,d);h>0&&(c="left"),o[c][r.type]||(o[c][r.type]=0),o[c].push(r),o[c][r.type]++}var u=o.left.dog?o.left.dog:0,l=o.right.dog?o.right.dog:0,g=o.left.cat?o.left.cat:0,f=o.right.cat?o.right.cat:0,m=Math.abs(f-g)+Math.abs(l-u);0==m?this.soundFX.play("awesome"):this.soundFX.play("oh-no"),e-=m,0>e&&(e=0),this.score+=e;var v=BASE_SCORE*Math.pow(this.level,2);this.score>v?this.nextLevel():console.log("Next Level Score: ",v),document.getElementById("scoreboard").innerHTML=this.score},Game.prototype.nextLevel=function(){this.level=this.level+1,this.setupLevel()},Game.prototype.loadSound=function(){};var game=new Game;