function randomInRange(t,e){return Math.floor(Math.random()*(1+e-t))+t}function plusOrMinus(){return Math.random()>.5?1:-1}function checkLeftOrRight(t,e,i,n,o,s){return(i-t)*(s-e)-(n-e)*(o-t)}function Game(){this.soundFX=new SoundFX,this.board=Snap(IDCANVAS),this.sepLine=this.board.line(0,0,0,600),this.sepLine.addClass("separate-line"),this.sepLine.attr("opacity",DRAG_OPACITY),this.mouseOriginPointer=this.board.circle(-100,-100,10),this.mouseOriginPointer.addClass("mouse-origin-pointer"),this.mouseOriginPointer.attr("opacity",DRAG_OPACITY)}function Character(t,e,i,n){var o=30,s=t.board.image("images/characters/"+e+".png",i,n,o,o);s.type=e,s.direction=Math.random()*plusOrMinus(),s.moveTurn=randomInRange(0,50);var a=plusOrMinus(),r=plusOrMinus();return s.move=function(t,e,i){var n=parseInt(s.attr("x")),p=parseInt(s.attr("y"));50==++s.moveTurn&&(s.moveTurn=0,a=plusOrMinus(),r=plusOrMinus()),delX=a*i*MOVEMENT_CHARACTER[s.type].speedX,delY=r*i*MOVEMENT_CHARACTER[s.type].speedY,n+=delX,p+=delY,(o>n||n>t-o)&&(n-=2*delX,a*=plusOrMinus(),r*=plusOrMinus()),(o>p||p>e-o)&&(p-=2*delY,a*=plusOrMinus(),r*=plusOrMinus()),s.attr("x",n),s.attr("y",p)},s}function SoundFX(){Object.keys(SOUNDFX).forEach(function(t){var e=SOUNDFX[t];createjs.Sound.registerSound(e,t)}),this.play=function(t){createjs.Sound.play(t)}}function startGame(){$("#control-pane").hide(),$("#start-pane").hide(),$("#end-pane").show(),game.init()}function replay(){$("#control-pane").hide(),game.replay()}var IDCANVAS="#game-board",BASE_SCORE=10,SPECIAL_ITEMS_TRADE=3,DIAMOND_MULTIPIER=10,DRAG_OPACITY=.5,STATE={IDLE:0,SELECTING:1,WAITING:2,TIMEUP:3},DURATION={selecting:1e3,waiting:1e3,game:60},LEVEL_SETTING={1:{objects:{cat:2,dog:2}},2:{objects:{cat:2,dog:2}}},MAX_LEVEL=Object.keys(LEVEL_SETTING).splice(-1,1),MOVEMENT_CHARACTER={dog:{speedX:5,speedY:5},cat:{speedX:6,speedY:6}},SOUNDFX={addObject:"https://www.freesound.org/data/previews/21/21389_36084-lq.mp3",awesome:"https://www.freesound.org/data/previews/187/187925_3140412-lq.mp3","oh-no":"http://freesound.org/data/previews/131/131409_2337290-lq.mp3",error:"http://freesound.org/data/previews/188/188013_2906575-lq.mp3"};Game.prototype.init=function(){this.setupEnvironment(),this.initEvents(),this.setupLevel(),this.initObjectMovement(),document.getElementById("time").innerHTML=this.duration,this.start()},Game.prototype.replay=function(){for(var t=0;t<this.objects.length;t++)this.objects[t].remove();this.init()},Game.prototype.setupEnvironment=function(){this.duration=DURATION.game,this.state=STATE.IDLE,this.score=0,this.objects=[],this.level=1,this.prevState="idle",this.diamond=0,$("#scoreboard").text(this.score),$("#special-item").text(this.diamond)},Game.prototype.initEvents=function(){function t(){e.mouseOriginPointer.animate({opacity:0},DURATION.selecting,function(){this.attr("opacity",DRAG_OPACITY),this.removeClass("show")}),e.sepLine.animate({opacity:0},DURATION.selecting,function(){this.removeClass("show"),this.attr("opacity",DRAG_OPACITY),e.setState("waiting"),setTimeout(function(){e.setState("idle")},DURATION.waiting)})}var e=this;this.board.drag(function(i,n,o,s,a){if(2!=a.button){if(e.sepLine.dx=i,e.sepLine.dy=n,console.log("dx and dy",e.sepLine.dx+" "+e.sepLine.dy),e.state==STATE.WAITING)return void console.log("Please wait a little bit.");e.sepLine.addClass("show"),e.setState("selecting"),t();for(var r=[0,600],p=0;p<r.length;p++){var c="x"+(p+1);r[p]=i/n*(r[p]-e.sepLine.originY)+e.sepLine.originX,e.sepLine.attr(c,r[p])}}},function(t,i,n){2!=n.button&&(e.mouseOriginPointer.attr("cx",t),e.mouseOriginPointer.attr("cy",i),e.mouseOriginPointer.addClass("show"),e.state!=STATE.waiting&&e.state!=STATE.TIMEUP&&(e.sepLine.originX=t,e.sepLine.originY=i))},function(i,n){if(2!=event.button){if(Math.abs(e.dx)<3||Math.abs(e.dy)<3)return console.log("small line"),void(e.state==STATE.SELECTING&&t());e.computeScore(),e.state==STATE.SELECTING&&t(),e.sepLine.dx=0,e.sepLine.dy=0}}),$(IDCANVAS).bind("contextmenu",function(t){return e.useSpecialItem(),!1})},Game.prototype.initObjectMovement=function(){var t=this;this.movement_timer=setInterval(function(){var e=.5;t.state==STATE.SELECTING&&(e=.02);for(var i=0;i<t.objects.length;i++)t.objects[i].move(t.board.node.offsetWidth,t.board.node.offsetHeight,e)},50)},Game.prototype.start=function(){var t=this;t.timer=setInterval(function(){var e=t.duration--;document.getElementById("time").innerHTML=e,0==e&&t.stop()},1e3)},Game.prototype.stop=function(){clearInterval(this.timer),clearInterval(this.movement_timer),this.setState("timeup");var t=this.score+DIAMOND_MULTIPIER*this.diamond;$("#final-score").text(t),showDOM("control-pane")},Game.prototype.setupLevel=function(){var t=this,e=this.level;this.level>MAX_LEVEL&&(e=MAX_LEVEL);var i=LEVEL_SETTING[e];console.log(i.objects),Object.keys(i.objects).forEach(function(e){for(var n=0;n<i.objects[e];n++){t.soundFX.play("addObject");var o=new Character(t,e,randomInRange(15,t.board.node.offsetWidth-15),randomInRange(15,t.board.node.offsetHeight-15));t.objects.push(o)}})},Game.prototype.setState=function(t){var e=t.toUpperCase();if(console.log(e),-1==Object.keys(STATE).indexOf(e))throw new Error("This state doesn't exist : "+e);this.board.removeClass(this.prevState),this.state=STATE[t.toUpperCase()],this.board.addClass(t),this.prevState=t},Game.prototype.computeScore=function(){console.log("scoringgg");for(var t=this.objects.length/2,e=this.sepLine.originX,i=this.sepLine.originY,n=e+this.sepLine.dx,o=i+this.sepLine.dy,s={left:[],right:[]},a=0;a<this.objects.length;++a){var r=this.objects[a],p=r.attr("x"),c=r.attr("y"),h="right",d=checkLeftOrRight(e,i,n,o,p,c);d>0&&(h="left"),s[h][r.type]||(s[h][r.type]=0),s[h].push(r),s[h][r.type]++}var l=s.left.dog?s.left.dog:0,u=s.right.dog?s.right.dog:0,m=s.left.cat?s.left.cat:0,g=s.right.cat?s.right.cat:0,f=Math.abs(g-m)+Math.abs(u-l);0==f?this.awesome():this.soundFX.play("oh-no"),t-=f,0>t&&(t=0),this.score+=t;var E=BASE_SCORE*Math.pow(this.level,2);this.score>E?this.nextLevel():console.log("Next Level Score: ",E),document.getElementById("scoreboard").innerHTML=this.score},Game.prototype.nextLevel=function(){this.level=this.level+1,this.setupLevel()},Game.prototype.awesome=function(){this.diamond=this.diamond+1,this.soundFX.play("awesome"),this._animateSpecial("+",1)},Game.prototype._animateSpecial=function(t,e){var i=this;$("#special-animation").text(t+e),$("#special-animation").show(),$("#special-animation").fadeOut(function(){$("#special-item").text(i.diamond)})},Game.prototype.useSpecialItem=function(){this.diamond>=SPECIAL_ITEMS_TRADE?(this.diamond=this.diamond-SPECIAL_ITEMS_TRADE,this._animateSpecial("-",SPECIAL_ITEMS_TRADE),console.log("Use item!")):($("#special-item-wrapper").animate({opacity:0},200,"linear",function(){$(this).animate({opacity:1},200)}),this.soundFX.play("error"))},Character.prototype.point=function(){return new Point(obj.attr("x"),obj.attr("y"))};var game=new Game;