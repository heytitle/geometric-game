function randomInRange(t,e){return Math.floor(Math.random()*(1+e-t))+t}function plusOrMinus(){return Math.random()>.5?1:-1}function checkLeftOrRight(t,e,i,n,o,s){return(i-t)*(s-e)-(n-e)*(o-t)}function Point(t,e){this.x=t,this.y=e}function Line(t,e,i){0==t?this.m=1/0:this.m=e/t,this.c=i.y-this.m*i.x,this.originPoint=i}function Box(t,e){this.width=t,this.height=e,this.boundaries=[new Line(1,0,new Point(0,this.height/2)),new Line(1,0,new Point(0,-this.height/2)),new Line(0,1,new Point(this.width/2,0)),new Line(0,1,new Point(-this.width/2,0))]}function HamSandwich(t,e){this.set1=t,this.set2=e}function Game(){this.soundFX=new SoundFX,this.board=Snap(IDCANVAS),this.ham=new HamSandwich,this.sepLine=this.board.line(0,0,0,600),this.sepLine.addClass("separate-line"),this.sepLine.attr("opacity",DRAG_OPACITY),this.mouseOriginPointer=this.board.circle(-100,-100,10),this.mouseOriginPointer.addClass("mouse-origin-pointer"),this.mouseOriginPointer.attr("opacity",DRAG_OPACITY),this.SCALED_HEIGHT=this.board.node.offsetHeight/SCALING,this.SCALED_WIDTH=this.board.node.offsetWidth/SCALING,this.originBoundary=new Box(this.SCALED_WIDTH,this.SCALED_HEIGHT)}function Character(t,e,i,n){var o=30,s=t.board.image("images/characters/"+e+".png",i,n,o,o);s.type=e,s.direction=Math.random()*plusOrMinus(),s.moveTurn=randomInRange(0,50);var r=plusOrMinus(),a=plusOrMinus();return s.move=function(t,e,i){var n=parseInt(s.attr("x")),h=parseInt(s.attr("y"));50==++s.moveTurn&&(s.moveTurn=0,r=plusOrMinus(),a=plusOrMinus()),delX=r*i*MOVEMENT_CHARACTER[s.type].speedX,delY=a*i*MOVEMENT_CHARACTER[s.type].speedY,n+=delX,h+=delY,(o>n||n>t-o)&&(n-=2*delX,r*=plusOrMinus(),a*=plusOrMinus()),(o>h||h>e-o)&&(h-=2*delY,r*=plusOrMinus(),a*=plusOrMinus()),s.attr("x",n),s.attr("y",h)},s.point=function(){var t=parseInt(s.attr("width")),e=parseInt(s.attr("height")),i=parseFloat(s.attr("x")),n=parseFloat(s.attr("y"));return new Point(i+t/2,n+e/2)},s}function SoundFX(){Object.keys(SOUNDFX).forEach(function(t){var e=SOUNDFX[t];createjs.Sound.registerSound(e,t)}),this.play=function(t){createjs.Sound.play(t)}}function startGame(){$("#control-pane").hide(),$("#start-pane").hide(),$("#end-pane").css("display","table"),game.init()}function replay(){$("#control-pane").hide(),game.replay()}var IDCANVAS="#game-board",BASE_SCORE=10,SPECIAL_ITEMS_TRADE=3,DIAMOND_MULTIPIER=10,DRAG_OPACITY=.5,SCALING=30,STATE={IDLE:0,SELECTING:1,WAITING:2,TIMEUP:3,USING_SPECIAL_ITEM:4},DURATION={selecting:1e3,waiting:1e3,game:60},LEVEL_SETTING={1:{objects:{cat:2,dog:2}},2:{objects:{cat:2,dog:2}}},MAX_LEVEL=Object.keys(LEVEL_SETTING).splice(-1,1),MOVEMENT_CHARACTER={dog:{speedX:5,speedY:5},cat:{speedX:6,speedY:6}},SOUNDFX={addObject:"https://www.freesound.org/data/previews/21/21389_36084-lq.mp3",awesome:"https://www.freesound.org/data/previews/187/187925_3140412-lq.mp3","oh-no":"http://freesound.org/data/previews/131/131409_2337290-lq.mp3",error:"http://freesound.org/data/previews/188/188013_2906575-lq.mp3"},ACCEPTABLE_ERROR=.001;Point.prototype.duality=function(){var t=new Line(1,this.x,new Point(0,-this.y));return t},Point.prototype.distanceFromPoint=function(t){var e=this.x-t.x,i=this.y-t.y;return Math.sqrt(Math.pow(e,2)+Math.pow(i,2))},Point.prototype.distanceFromOrigin=function(){return this.distanceFromPoint(new Point(0,0))},Point.prototype.inBoundary=function(t,e,i,n){return this.x>=t-ACCEPTABLE_ERROR&&this.x<=i+ACCEPTABLE_ERROR&&this.y>=e-ACCEPTABLE_ERROR&&this.y<=n+ACCEPTABLE_ERROR?!0:!1},Line.prototype.findPointOnLine=function(t){var e=new Point(t,void 0);return e.y=this.m*e.x+this.c,e},Line.prototype.isPointOnLine=function(t){return this.m==1/0?t.x==this.originPoint.x:this.findPointOnLine(t.x).y==t.y},Line.prototype.isPointAbove=function(t){return this.m==1/0?t.x<=this.originPoint.x:t.y>=this.findPointOnLine(t.x).y},Line.prototype.intersectWithLine=function(t){if(this.m==t.m)return null;var e;e=this.m==1/0||t.m==1/0?this.m==1/0?this.originPoint.x:t.originPoint.x:(this.c-t.c)/(t.m-this.m);var i=this.m*e+this.c;return new Point(e,i)},Box.prototype.intersectWithLine=function(t){for(var e=[],i=0;i<this.boundaries.length;i++){var n=this.boundaries[i],o=t.intersectWithLine(n);o.inBoundary(-this.width/2,-this.height/2,this.width/2,this.height/2)&&e.push(o)}return e},MIN_NUMBER=-65e3,MAX_NUMBER=65e3,HamSandwich.prototype.findMedian=function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i].findPointOnLine(MIN_NUMBER);e.push(n)}e.sort(this.sortPointBy("y"));var o=e[Math.floor(t.length/2)];for(events=[o],i=0;i<t.length-1;i++)for(p=i+1;p<t.length;p++){var s=t[i].intersectWithLine(t[p]);events.push(s)}events.sort(this.sortPointBy("x"));for(var r,a=[],h=[],i=0;i<events.length;i++){for(var n=events[i],d=[],p=0;p<t.length;p++){var c=t[p],u=c.findPointOnLine(n.x);d.push(u)}d.sort(this.sortPointBy("y")),median=d[Math.floor(d.length/2)];for(var p=0;p<t.length;p++){var c=t[p];c.isPointOnLine(median)&&a.push(c)}a[a.length-1].isPointOnLine(n)&&(h.push(n),1==h.length&&(r=a[0]))}var l=a[0].findPointOnLine(MAX_NUMBER);return h.push(l),h},HamSandwich.prototype.findIntersection=function(t,e){for(index1=0,index2=0;index1<t.length-1&&index2<e.length-1;){if(startPoint1=t[index1],endPoint1=t[index1+1],startPoint2=e[index2],endPoint2=e[index2+1],line1=new Line(endPoint1.x-startPoint1.x,endPoint1.y-startPoint1.y,startPoint1),line2=new Line(endPoint2.x-startPoint2.x,endPoint2.y-startPoint2.y,startPoint2),intersection=line1.intersectWithLine(line2),null!=intersection&&(intersection.x-startPoint1.x)*(intersection.x-endPoint1.x)<=0&&(intersection.y-startPoint2.y)*(intersection.y-endPoint2.y)<=0)return intersection;t[index1+1].x>e[index2+1].x?index2++:index1++}},HamSandwich.prototype.sortPointBy=function(t){return function(e,i){return e[t]-i[t]}},Game.prototype.init=function(){this.setupEnvironment(),this.initEvents(),this.setupLevel(),this.initObjectMovement(),document.getElementById("time").innerHTML=this.duration,this.start()},Game.prototype.replay=function(){for(var t=0;t<this.objects.length;t++)this.objects[t].remove();this.init()},Game.prototype.setupEnvironment=function(){this.duration=DURATION.game,this.state=STATE.IDLE,this.score=0,this.objects=[],this.level=1,this.prevState="idle",this.diamond=0,$("#scoreboard").text(this.score),$("#special-item").text(this.diamond)},Game.prototype.initEvents=function(){function t(){e.mouseOriginPointer.animate({opacity:0},DURATION.selecting,function(){this.attr("opacity",DRAG_OPACITY),this.removeClass("show")}),e.sepLine.animate({opacity:0},DURATION.selecting,function(){this.removeClass("show"),this.attr("opacity",DRAG_OPACITY),e.setState("waiting"),setTimeout(function(){e.setState("idle")},DURATION.waiting)})}var e=this;this.board.drag(function(i,n,o,s,r){if(2!=r.button){if(e.sepLine.dx=i,e.sepLine.dy=n,console.log("dx and dy",e.sepLine.dx+" "+e.sepLine.dy),e.state==STATE.WAITING)return void console.log("Please wait a little bit.");e.sepLine.addClass("show"),e.mouseOriginPointer.addClass("show"),e.setState("selecting"),t();for(var a=[0,600],h=0;h<a.length;h++){var d="x"+(h+1);a[h]=i/n*(a[h]-e.sepLine.originY)+e.sepLine.originX,e.sepLine.attr(d,a[h])}}},function(t,i,n){2!=n.button&&e.state!=STATE.USING_SPECIAL_ITEM&&(e.mouseOriginPointer.attr("cx",t),e.mouseOriginPointer.attr("cy",i),e.state!=STATE.waiting&&e.state!=STATE.TIMEUP&&(e.sepLine.originX=t,e.sepLine.originY=i))},function(i,n){if(e.state==STATE.SELECTING||e.state==STATE.WAITING){if(console.log("xxxxxxxxxx"),console.log(event),Math.abs(e.dx)<3||Math.abs(e.dy)<3)return console.log("small line"),void(e.state==STATE.SELECTING&&(e.computeScore(),t()));e.computeScore(),e.state==STATE.SELECTING&&t(),e.sepLine.dx=0,e.sepLine.dy=0}}),$(IDCANVAS).bind("contextmenu",function(t){return e.useSpecialItem(),!1})},Game.prototype.initObjectMovement=function(){var t=this;this.movement_timer=setInterval(function(){if(t.state!=STATE.USING_SPECIAL_ITEM){var e=.5;t.state==STATE.SELECTING&&(e=.02);for(var i=0;i<t.objects.length;i++)t.objects[i].move(t.board.node.offsetWidth,t.board.node.offsetHeight,e)}},50)},Game.prototype.start=function(){var t=this;t.timer=setInterval(function(){var e=t.duration--;document.getElementById("time").innerHTML=e,0==e&&t.stop()},1e3)},Game.prototype.stop=function(){clearInterval(this.timer),clearInterval(this.movement_timer),this.setState("timeup"),this.board.undrag();var t=this.score+DIAMOND_MULTIPIER*this.diamond;$("#final-score").text(t),$("#control-pane").show()},Game.prototype.setupLevel=function(){var t=this,e=this.level;this.level>MAX_LEVEL&&(e=MAX_LEVEL);var i=LEVEL_SETTING[e];console.log(i.objects),Object.keys(i.objects).forEach(function(e){for(var n=0;n<i.objects[e];n++){t.soundFX.play("addObject");var o=new Character(t,e,randomInRange(15,t.board.node.offsetWidth-15),randomInRange(15,t.board.node.offsetHeight-15));t.objects.push(o)}})},Game.prototype.setState=function(t){var e=t.toUpperCase();if(console.log(e),-1==Object.keys(STATE).indexOf(e))throw new Error("This state doesn't exist : "+e);this.board.removeClass(this.prevState),this.state=STATE[t.toUpperCase()],this.board.addClass(t),this.prevState=t},Game.prototype.computeScore=function(){for(var t=this.objects.length/2,e=this.sepLine.originX,i=this.sepLine.originY,n=e+this.sepLine.dx,o=i+this.sepLine.dy,s={left:[],right:[]},r=0;r<this.objects.length;++r){var a=this.objects[r],h=a.attr("x"),d=a.attr("y"),p="right",c=checkLeftOrRight(e,i,n,o,h,d);c>0&&(p="left"),s[p][a.type]||(s[p][a.type]=0),s[p].push(a),s[p][a.type]++}var u=s.left.dog?s.left.dog:0,l=s.right.dog?s.right.dog:0,m=s.left.cat?s.left.cat:0,f=s.right.cat?s.right.cat:0,g=Math.abs(f-m)+Math.abs(l-u);0==g?this.awesome():this.soundFX.play("oh-no"),t-=g,0>t&&(t=0),this.score+=t;var y=BASE_SCORE*Math.pow(this.level,2);this.score>y?this.nextLevel():console.log("Next Level Score: ",y),document.getElementById("scoreboard").innerHTML=this.score},Game.prototype.nextLevel=function(){this.level=this.level+1,this.setupLevel()},Game.prototype.awesome=function(){this.diamond=this.diamond+1,this.soundFX.play("awesome"),this._animateSpecial("+",1)},Game.prototype._animateSpecial=function(t,e){var i=this;$("#special-animation").text(t+e),$("#special-animation").show(),$("#special-animation").fadeOut(function(){$("#special-item").text(i.diamond)})},Game.prototype.useSpecialItem=function(){if(this.diamond>=SPECIAL_ITEMS_TRADE&&this.state==STATE.IDLE){this.diamond=this.diamond-SPECIAL_ITEMS_TRADE,this._animateSpecial("-",SPECIAL_ITEMS_TRADE),this.setState("using_special_item");for(var t={cat:[],dog:[]},e=0;e<this.objects.length;e++){var i=this.objects[e],n=this.toOriginCoordinate(i.point());t[i.type].push(n.duality())}for(var o=Object.keys(t),s=[],e=0;e<o.length;e++){var r=o[e],a=this.ham.findMedian(t[r]);s.push(a)}for(var h=this.ham.findIntersection(s[0],s[1]),d=this.originBoundary.intersectWithLine(h.duality()),p=0,c=0,e=0;e<d.length;e++){var n=d[e];d[e]=this.toCanvasCoordinate(n),p=d[e].x/d.length,c=d[e].y/d.length}var p=(d[0].x+d[1].x)/2,c=(d[0].y+d[1].y)/2,u=new Point(p,c),l=this.board.circle(u.x,u.y,10);l.attr("opacity",DRAG_OPACITY),this.setOriginSepLine(u);var m;DEBUG&&(m=this.board.line(d[0].x,d[0].y,d[1].x,d[1].y),m.attr({stroke:"#000"}));var f=this;f.sepLine.addClass("show"),f.board.mousemove(function(t){f.updateSepLine(u.x-t.x,u.y-t.y)}),setTimeout(function(){f.computeScore(),l.remove(),m&&m.remove(),f.sepLine.removeClass("show"),f.board.unmousemove(),f.setState("IDLE")},DURATION.selecting*f.objects.length/2)}else $("#special-item-wrapper").animate({opacity:0},200,"linear",function(){$(this).animate({opacity:1},200)}),this.soundFX.play("error")},Game.prototype.setOriginSepLine=function(t){this.sepLine.originX=t.x,this.sepLine.originY=t.y},Game.prototype.updateSepLine=function(t,e){var i=[0,600];console.log("scoringgg"),console.log(this.state);for(var n=0;n<i.length;n++){var o="x"+(n+1);i[n]=t/e*(i[n]-this.sepLine.originY)+this.sepLine.originX,this.sepLine.attr(o,i[n])}this.sepLine.dx=t,this.sepLine.dy=e},Game.prototype.toOriginCoordinate=function(t){return new Point((t.x-this.board.node.offsetWidth/2)/SCALING,(this.board.node.offsetHeight/2-t.y)/SCALING)},Game.prototype.toCanvasCoordinate=function(t){var e=SCALING*t.x+this.board.node.offsetWidth/2,i=this.board.node.offsetHeight/2-SCALING*t.y;return new Point(e,i)};var DEBUG=!1;location.href.match(/debug=1/)&&(DEBUG=1);var game=new Game;